<!DOCTYPE html>
<html>
   <head>
       <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

       <title>Babylon.js sample code</title>

       <!-- Babylon.js -->
       <script src="https://code.jquery.com/pep/0.4.2/pep.min.js"></script>
       <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
       <script src="https://preview.babylonjs.com/ammo.js"></script>
       <script src="https://preview.babylonjs.com/cannon.js"></script>
       <script src="https://preview.babylonjs.com/Oimo.js"></script>
       <script src="https://preview.babylonjs.com/gltf_validator.js"></script>
       <script src="https://preview.babylonjs.com/earcut.min.js"></script>
       <script src="https://preview.babylonjs.com/babylon.js"></script>
       <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
       <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
       <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
       <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
       <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
       <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
       <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
      <script src="https://preview.babylonjs.com/loaders/babylon.glTFFFileLoader.js"></script>

       <style>
           html, body {
               overflow: hidden;
               width: 100%;
               height: 100%;
               margin: 0;
               padding: 0;
           }

           #renderCanvas {
               width: 100%;
               height: 100%;
               touch-action: none;
           }
       </style>
   </head>
<body>
   <canvas id="renderCanvas"></canvas>
   <script>
       var canvas = document.getElementById("renderCanvas");

    

    var timer;
 var timerclick;
 var timervideo;

var createScene = function () {

/*------ Initialisation Scène & Camera ------*/     
var scene = new BABYLON.Scene(engine);
var camera = new BABYLON.ArcRotateCamera("Camera", -Math.PI / 2,  Math.PI / 2, 5, BABYLON.Vector3.Zero(), scene);
camera.attachControl(canvas, true);
camera.inputs.attached.mousewheel.detachControl(canvas);


/*---------Ajout de la VR-------------------*/     

var vrHelper = scene.createDefaultVRExperience();

vrHelper.displayGaze = true ;
vrHelper.displayLaserPointer = true;
vrHelper.changeGazeColor(new BABYLON.Color3(1,1,1));
vrHelper.enableInteractions();
/*-------- Création Matériaux---------------*/
var greenMat = new BABYLON.StandardMaterial("green", scene);
    greenMat.diffuseColor = new BABYLON.Color3(0, 255, 0);
    greenMat.emissiveColor = new BABYLON.Color3(0, 255, 0);
    greenMat.specularColor = new BABYLON.Color3(0, 255, 0);

var redMat = new BABYLON.StandardMaterial("red", scene);
    redMat.diffuseColor = new BABYLON.Color3(255, 0, 0);
    redMat.emissiveColor = new BABYLON.Color3(255, 0, 0);
    redMat.specularColor = new BABYLON.Color3(255, 0, 0);

/*---------Création de la première photo ---------------*/
createPhoto1(scene,redMat,greenMat);


return scene;
};

var createPhoto1= function(scene, redMat, greenMat)
{
 //--------- Chargement de la photo 360°--------------
var dome = new BABYLON.PhotoDome(
   "testdome",
   "./textures/360photo.jpg",
   {
       resolution: 32,
       size: 1000
   },
   scene
);


//----------------------Création Sphère--------

var sphere = BABYLON.Mesh.CreateSphere("sphere1", 16, 1, scene);

// positionnement de la sphère
sphere.material = redMat;
sphere.position.x = 1;
sphere.position.y = 0;
sphere.position.z = 0; 

// Nécessaire si on veut utiliser BABYLON.GUI, variable dans laquelle 
// on va stocker les objets GUI utilisés (les étiquettes des sphères) 
var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");


//Création de l'étiquette de la boule

var rect1 = new BABYLON.GUI.Rectangle();
rect1.width = 0.1;
rect1.height = "20px";
rect1.cornerRadius = 20;
rect1.color = "black";
rect1.thickness = 2;
rect1.background = "white";
advancedTexture.addControl(rect1);
var label = new BABYLON.GUI.TextBlock();
label.text = "Entrée";
rect1.addControl(label);

rect1.linkWithMesh(sphere);   // On lie l'étiquette à la sphère
rect1.linkOffsetY = -50;

//--------Création d'un manager: gère les actions relatives à la sphère------
sphere.actionManager = new BABYLON.ActionManager(scene);

//-------Trigger déclenché lors d'un survol de la sphère par le pointeur---------

sphere.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOverTrigger, function () {

    // la sphère devient verte pour aider à la navigation de l'utilisateur et 
    //         à notifier que le pointeur est sur la sphère                   
        sphere.material = greenMat;
   
       
        // Code à exécuter au bout de 2sec
        timer = setTimeout( function(){
    //-------Destruction de la photo actuelle-------
        
        advancedTexture.dispose();
        sphere.dispose();
        dome.dispose();

    //------Création de la prochaine photo 360-------
        createPhoto2(scene,redMat,greenMat);
   
        },1000);
}));
  
//-----Trigger du pointeur une fois qu'il quitte la sphere APRES l'avoir survolée------
sphere.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOutTrigger, function () {
    
        clearTimeout(timer)
        clearTimeout(timervideo);
        sphere.material = redMat;
       
    
}));   

//-----Trigger du click SOURIS (non celui du controller casque)----------
sphere.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickUpTrigger, function () {
    
    // On met un setTimeout de 0.4sec (et pas MOINS) car n'en mettant       
    // pas, si l'utilisateur commence directement à tourner la caméra alors 
    //         un bug d'image survient                                     
    timerclick = setTimeout( function(){
    //-------Destruction de la photo actuelle-------
        
        advancedTexture.dispose();
        sphere.dispose();
        dome.dispose();

    //------Création de la prochaine photo 360-------
        createPhoto2(scene,redMat,greenMat);
   
    },400);

}));



};

var createPhoto2= function(scene,redMat,greenMat)
{
//------Création de la photo 360° 
var dome = new BABYLON.PhotoDome(
   "testdome",
   "./textures/equirectangular.jpg",
   {
       resolution: 32,
       size: 1000
   },
   scene
);

// Nécessaire si on veut utiliser BABYLON.GUI, variable dans laquelle 
// on va stocker les objets GUI utilisés (les étiquettes des sphères) 
var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

//----------------------Création Sphère-------------

var sphere1 = BABYLON.Mesh.CreateSphere("sphere1", 16, 1, scene);
var sphere2 = BABYLON.Mesh.CreateSphere("sphere2", 16, 1, scene);
var sphere3 = BABYLON.Mesh.CreateSphere("sphere3", 16, 1, scene);


// positionnement + matériaux des sphères
sphere1.material = redMat;
sphere1.position.x = -3;
sphere1.position.y = 0;
sphere1.position.z = 0; 

sphere2.material = redMat;
sphere2.position.x = 3;
sphere2.position.y = 0;
sphere2.position.z = 0; 

sphere3.material = redMat;
sphere3.position.x = 0;
sphere3.position.y = 1;
sphere3.position.z = 0; 


// Création des étiquettes des sphères
var rect1 = new BABYLON.GUI.Rectangle();
rect1.width = 0.1;
rect1.height = "20px";
rect1.cornerRadius = 20;
rect1.color = "black";
rect1.thickness = 2;
rect1.background = "white";
advancedTexture.addControl(rect1);

var label1 = new BABYLON.GUI.TextBlock();
label1.text = "Vers 1ere Photo";
rect1.addControl(label1);
rect1.linkWithMesh(sphere1);  
rect1.linkOffsetY = -50;


var rect2 = new BABYLON.GUI.Rectangle();
rect2.width = 0.1;
rect2.height = "20px";
rect2.cornerRadius = 20;
rect2.color = "black";
rect2.thickness = 2;
rect2.background = "white";
advancedTexture.addControl(rect2);

var label2 = new BABYLON.GUI.TextBlock();
label2.text = "Vers 3e photo";
rect2.addControl(label2);
rect2.linkWithMesh(sphere2);  
rect2.linkOffsetY = -50;


var rect3 = new BABYLON.GUI.Rectangle();
rect3.width = 0.1;
rect3.height = "20px";
rect3.cornerRadius = 20;
rect3.color = "black";
rect3.thickness = 2;
rect3.background = "white";
advancedTexture.addControl(rect3);

var label3 = new BABYLON.GUI.TextBlock();
label3.text = "Vidéo";
rect3.addControl(label3);
rect3.linkWithMesh(sphere3);  
rect3.linkOffsetY = -50;


// Fabrication de la vidéo 

var show = false;
var playing = false;

var light = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(0, 1, 0), scene);
    light.intensity = 1.5;
	
    // Create a material from the video
	var mat = new BABYLON.StandardMaterial("mat", scene);
	var videoTexture = new BABYLON.VideoTexture("video", ["./textures/babylonjs.mp4", "textures/babylonjs.webm"], scene, true, false);
	mat.diffuseTexture = videoTexture;

    // Attach the video material the a mesh
    var plan = BABYLON.Mesh.CreatePlane("plane1", 2, scene);
    plan.scaling.x = 1920/1080; // set aspect ratio
	plan.material = mat;
    plan.isVisible = false;
    plan.position.x = 1;
    plan.position.y =2.5;
    videoTexture.video.pause();

    // Create the 3D UI manager
    var manager = new BABYLON.GUI.GUI3DManager(scene);

    // Let's add a button
    var button = new BABYLON.GUI.HolographicButton("restart");
    manager.addControl(button);
    
    button.position.x = 2.5;
    button.position.y = 1.5;
    button.scaling.x = 0.5;
    button.scaling.y = 0.5;
   var image = new BABYLON.GUI.Image("reset", "./textures/reset.jpg");
image.stretch = BABYLON.GUI.Image.STRETCH_FILL;
button.content = image;
    button.onPointerUpObservable.add(function(){
        videoTexture.video.currentTime =0;
    });

//--------Création des managers: gèrent les actions relatives aux sphères------

sphere1.actionManager = new BABYLON.ActionManager(scene);
sphere2.actionManager = new BABYLON.ActionManager(scene);
sphere3.actionManager = new BABYLON.ActionManager(scene);
plan.actionManager = new BABYLON.ActionManager(scene);


//-------------------- Triggers liés au plan de la vidéo-----------------
plan.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickUpTrigger, function () {
            if(playing){
            videoTexture.video.pause();
            playing = !playing;
            }
            else{
            videoTexture.video.play();
            playing = !playing;
            }
        }));
    
    plan.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOverTrigger, function () {
            
            timervideo = setTimeout( function(){
            if(playing){
            videoTexture.video.pause();
            playing = !playing;
            }
            else{
            videoTexture.video.play();
            playing = !playing;
            }
            }, 500);

        }));


 //-----Trigger du click SOURIS (non celui du controller casque)----------
sphere1.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickUpTrigger, function () {
    timer = setTimeout( function(){
    //-------Destruction de la photo actuelle-------
        dome.dispose();
        advancedTexture.dispose();
        sphere1.dispose();
        sphere2.dispose();
        sphere3.dispose();
        plan.dispose();

    //------Création de la prochaine photo 360-------
        createPhoto(scene, redMat,greenMat);
   
    },400);
}));

sphere2.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickUpTrigger, function () {
    
        timer = setTimeout( function(){
    //-------Destruction de la photo actuelle-------
        dome.dispose();
        advancedTexture.dispose();
        sphere1.dispose();
        sphere2.dispose();
        sphere3.dispose();
        plan.dispose();
    //------Création de la prochaine photo 360-------
        createPhoto3(scene, redMat,greenMat);
    
    },400);
  
}));

    

sphere3.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickUpTrigger, function () {
    
     
        

    if(!show)
    {
        plan.isVisible = true;
        videoTexture.video.play();
       
        playing = !playing
        
    }

    else
    {
        plan.isVisible = false;
        videoTexture.video.pause();
    }
    
    show = !show;
  

}));





/*  // à coder pour le headSet
sphere1.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOverTrigger, function (mesh) {
    var gamepadManager = new BABYLON.GamepadManager();
    gamepadManager.onGamepadConnectedObservable.add((gamepad, state)=>{
    gamepad.onButtonDownObservable.add((button, state)=>{
    //Button has been pressed
    var scene= createScene();
    engine.stopRenderLoop();
    engine.runRenderLoop(function(){
           advancedTexture.dispose();
           advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI", true, scene);
           scene.render();
        });
   scene1.autoclear = true;
   scene1.dispose();
   scene1 = null; 

    })});
}));*/




//---------------Triggers liés au survol des sphères par le pointeur---------


sphere1.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOverTrigger, function () {
    
    sphere1.material = greenMat;
    timer = setTimeout( function(){
    //-------Destruction de la photo actuelle-------
        dome.dispose();
        advancedTexture.dispose();
        advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
        sphere1.dispose();
        sphere2.dispose();
        sphere3.dispose();
        plan.dispose();

    //------Création de la prochaine photo 360-------
        createPhoto1(scene, redMat,greenMat);
   
    },1000);
  
}));


sphere2.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOverTrigger, function () {
   
   sphere2.material = greenMat;
   
   
}));

sphere3.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOverTrigger, function () {

    // la sphère devient verte pour aider à la navigation de l'utilisateur et 
    //         à notifier que le pointeur est sur la sphère                   
        sphere3.material = greenMat;
   
       
        // Code à exécuter au bout de 2sec
        timervideo = setTimeout( function(){
 
        

    if(!show)
    {

        
        
        plan.isVisible = true;
        videoTexture.video.play();
       
        playing = !playing
        
    }

    else
    {
        plan.isVisible = false;
        videoTexture.video.pause();
    }
    
    show = !show;
   
   
        },1000);
}));

sphere1.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOutTrigger, function () {
    
    sphere1.material = redMat;
    clearTimeout(timer);
  
}));

sphere2.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOutTrigger, function () {
    
    sphere3.material = redMat;
    clearTimeout(timer);
  
}));

sphere3.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOutTrigger, function () {
    
    sphere3.material = redMat;
    clearTimeout(timervideo);
  
}));


}
       



         
      
      
       var engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });
       var scene = createScene();

       engine.runRenderLoop(function () {
           if (scene) {
               scene.render();
           }
       });

       // Resize
       window.addEventListener("resize", function () {
           engine.resize();
       });
   </script>
</body>
</html>


